name: Build sing-box reF1nd

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"

jobs:
  # 第一步：获取各分支对应的最新 Tag
  check:
    runs-on: ubuntu-latest
    outputs:
      main_tag: ${{ steps.tags.outputs.main_tag }}
      dev_tag: ${{ steps.tags.outputs.dev_tag }}
    steps:
      - id: tags
        run: |
          # 提取稳定版 Tag (用于 main)
          MAIN=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9.]+$' | sort -V | tail -n1)
          # 提取所有最新 Tag (用于 dev)
          DEV=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9].*$' | sort -V | tail -n1)
          echo "main_tag=$MAIN" >> $GITHUB_OUTPUT
          echo "dev_tag=$DEV" >> $GITHUB_OUTPUT

  # 第二步：根据 YAML 矩阵进行编译
  build:
    needs: check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
        # 定义笛卡尔积组合
        include:
          # Android: 仅 arm64
          - { os: android, arch: arm64, v: "", branch: reF1nd-main }
          - { os: android, arch: arm64, v: "", branch: reF1nd-dev }

          # Linux: amd64 (兼容, v3, v4) + arm64
          - { os: linux, arch: amd64, v: "", branch: reF1nd-main }
          - { os: linux, arch: amd64, v: v3, branch: reF1nd-main }
          - { os: linux, arch: amd64, v: v4, branch: reF1nd-main }
          - { os: linux, arch: arm64, v: "", branch: reF1nd-main }
          - { os: linux, arch: amd64, v: "", branch: reF1nd-dev }
          - { os: linux, arch: amd64, v: v3, branch: reF1nd-dev }
          - { os: linux, arch: amd64, v: v4, branch: reF1nd-dev }
          - { os: linux, arch: arm64, v: "", branch: reF1nd-dev }

          # Windows: 同 Linux
          - { os: windows, arch: amd64, v: "", branch: reF1nd-main }
          - { os: windows, arch: amd64, v: v3, branch: reF1nd-main }
          - { os: windows, arch: amd64, v: v4, branch: reF1nd-main }
          - { os: windows, arch: arm64, v: "", branch: reF1nd-main }
          - { os: windows, arch: amd64, v: "", branch: reF1nd-dev }
          - { os: windows, arch: amd64, v: v3, branch: reF1nd-dev }
          - { os: windows, arch: amd64, v: v4, branch: reF1nd-dev }
          - { os: windows, arch: arm64, v: "", branch: reF1nd-dev }

          # MacOS (Darwin): 仅 amd64 + arm64, 无 v3/v4 区分
          - { os: darwin, arch: amd64, v: "", branch: reF1nd-main }
          - { os: darwin, arch: arm64, v: "", branch: reF1nd-main }
          - { os: darwin, arch: amd64, v: "", branch: reF1nd-dev }
          - { os: darwin, arch: arm64, v: "", branch: reF1nd-dev }

    steps:
      - name: Checkout Scripts
        uses: actions/checkout@v4
        with:
          path: "."

      - name: Checkout Upstream
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ matrix.branch }}
          path: src

      - uses: actions/setup-go@v5
        with:
          go-version: "stable"
          check-latest: true

      - name: Set Version Tag
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            echo "TAG=${{ needs.check.outputs.main_tag }}" >> $GITHUB_ENV
          else
            echo "TAG=${{ needs.check.outputs.dev_tag }}" >> $GITHUB_ENV
          fi

      - name: Build Core
        run: bash ../scripts/build.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG"
        working-directory: src

      - name: Package
        run: bash ../scripts/package.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG" "${{ matrix.branch }}"
        working-directory: src

      - name: Upload to Branch Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assets-${{ matrix.branch }}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.v }}
          path: output/*

  # 第三步：分发到不同的 Release
  publish:
    needs: [check, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
    steps:
      - name: Download Branch Assets
        uses: actions/download-artifact@v4
        with:
          pattern: assets-${{ matrix.branch }}-*
          path: dist
          merge-multiple: true

      - name: Set Release Tag
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            echo "REL_TAG=${{ needs.check.outputs.main_tag }}" >> $GITHUB_ENV
          else
            echo "REL_TAG=${{ needs.check.outputs.dev_tag }}-dev" >> $GITHUB_ENV
          fi

      - name: Create Branch Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.REL_TAG }}
          name: sing-box reF1nd [${{ matrix.branch }}]
          body: |
            Automated build for ${{ matrix.branch }}
            Source: https://github.com/reF1nd/sing-box/tree/${{ matrix.branch }}
          files: dist/*
