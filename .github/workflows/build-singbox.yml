name: Build sing-box reF1nd

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      main_tag: ${{ steps.tags.outputs.main_tag }}
      dev_tag: ${{ steps.tags.outputs.dev_tag }}
    steps:
      - id: tags
        run: |
          MAIN=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9.]+$' | sort -V | tail -n1)
          DEV=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9].*$' | sort -V | tail -n1)
          echo "main_tag=$MAIN" >> $GITHUB_OUTPUT
          echo "dev_tag=$DEV" >> $GITHUB_OUTPUT

  build:
    needs: check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # 直接使用 include 平铺，彻底避免合并歧义
      matrix:
        include:
          # --- reF1nd-main 分支 ---
          - { branch: reF1nd-main, os: android, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: v3 }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: v4 }
          - { branch: reF1nd-main, os: linux, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: v3 }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: v4 }
          - { branch: reF1nd-main, os: windows, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: darwin, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: darwin, arch: arm64, v: "" }

          # --- reF1nd-dev 分支 ---
          - { branch: reF1nd-dev, os: android, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: v3 }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: v4 }
          - { branch: reF1nd-dev, os: linux, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: v3 }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: v4 }
          - { branch: reF1nd-dev, os: windows, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: darwin, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: darwin, arch: arm64, v: "" }

    steps:
      - name: Checkout Scripts
        uses: actions/checkout@v4
        with:
          path: "."

      - name: Checkout Upstream
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ matrix.branch }}
          path: src

      - uses: actions/setup-go@v5
        with:
          go-version: "stable"
          check-latest: true

      - name: Build and Package
        env:
          MAIN_TAG: ${{ needs.check.outputs.main_tag }}
          DEV_TAG: ${{ needs.check.outputs.dev_tag }}
        run: |
          # 内部变量分拣
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            TAG=$MAIN_TAG
          else
            TAG=$DEV_TAG
          fi

          # 执行编译 (进入 src 目录)
          cd src
          bash ../scripts/build.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG"

          # 执行包装
          bash ../scripts/package.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG" "${{ matrix.branch }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # 注意：Artifact Name 必须唯一，防止并发冲突
          name: bin-${{ matrix.branch }}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.v }}
          path: output/*

  publish:
    needs: [check, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
    steps:
      - name: Download Assets
        uses: actions/download-artifact@v4
        with:
          # 根据前缀下载该分支的所有产物
          pattern: bin-${{ matrix.branch }}-*
          path: dist
          merge-multiple: true

      - name: Set Env
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            echo "REL_TAG=${{ needs.check.outputs.main_tag }}" >> $GITHUB_ENV
          else
            echo "REL_TAG=${{ needs.check.outputs.dev_tag }}-dev" >> $GITHUB_ENV
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.REL_TAG }}
          name: sing-box reF1nd [${{ matrix.branch }}]
          body: "Source Branch: ${{ matrix.branch }}"
          files: dist/*

  package_arch:
    needs: [check, build]
    runs-on: ubuntu-latest
    # 使用 ArchLinux 官方构建镜像，自带 makepkg 和 repo-add
    container: archlinux:base-devel
    strategy:
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
    steps:
      - uses: actions/checkout@v4
      
      # 下载该分支的所有 Artifacts
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bin-${{ matrix.branch }}-*
          path: artifacts

      - name: Init Environment
        run: |
          pacman -Syu --noconfirm git wget sudo
          # 允许 nobody 用户使用 sudo (makepkg 需要)
          echo "nobody ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Build Arch Repo
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            TAG=${{ needs.check.outputs.main_tag }}
          else
            TAG=${{ needs.check.outputs.dev_tag }}
          fi
          # 执行刚才那个脚本
          bash scripts/arch/build_repo.sh "${{ matrix.branch }}" "$TAG" "$(pwd)/artifacts" "${REPO_TOKEN}"