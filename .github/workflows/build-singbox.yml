name: Build sing-box reF1nd

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      main_tag: ${{ steps.tags.outputs.main_tag }}
      dev_tag: ${{ steps.tags.outputs.dev_tag }}
    steps:
      - id: tags
        run: |
          MAIN=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9.]+$' | sort -V | tail -n1)
          DEV=$(git ls-remote --tags https://github.com/SagerNet/sing-box.git | grep -Po 'refs/tags/\Kv[0-9].*$' | sort -V | tail -n1)
          echo "main_tag=$MAIN" >> $GITHUB_OUTPUT
          echo "dev_tag=$DEV" >> $GITHUB_OUTPUT

  build:
    needs: check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # ç›´æ¥ä½¿ç”¨ include å¹³é“ºï¼Œå½»åº•é¿å…åˆå¹¶æ­§ä¹‰
      matrix:
        include:
          # --- reF1nd-main åˆ†æ”¯ ---
          - { branch: reF1nd-main, os: android, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: v3 }
          - { branch: reF1nd-main, os: linux, arch: amd64, v: v4 }
          - { branch: reF1nd-main, os: linux, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: v3 }
          - { branch: reF1nd-main, os: windows, arch: amd64, v: v4 }
          - { branch: reF1nd-main, os: windows, arch: arm64, v: "" }
          - { branch: reF1nd-main, os: darwin, arch: amd64, v: "" }
          - { branch: reF1nd-main, os: darwin, arch: arm64, v: "" }

          # --- reF1nd-dev åˆ†æ”¯ ---
          - { branch: reF1nd-dev, os: android, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: v3 }
          - { branch: reF1nd-dev, os: linux, arch: amd64, v: v4 }
          - { branch: reF1nd-dev, os: linux, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: v3 }
          - { branch: reF1nd-dev, os: windows, arch: amd64, v: v4 }
          - { branch: reF1nd-dev, os: windows, arch: arm64, v: "" }
          - { branch: reF1nd-dev, os: darwin, arch: amd64, v: "" }
          - { branch: reF1nd-dev, os: darwin, arch: arm64, v: "" }

    steps:
      - name: Checkout Scripts
        uses: actions/checkout@v4
        with:
          path: "."

      - name: Checkout Upstream
        uses: actions/checkout@v4
        with:
          repository: reF1nd/sing-box
          ref: ${{ matrix.branch }}
          path: src

      - uses: actions/setup-go@v5
        with:
          go-version: "stable"
          check-latest: true

      - name: Build and Package
        env:
          MAIN_TAG: ${{ needs.check.outputs.main_tag }}
          DEV_TAG: ${{ needs.check.outputs.dev_tag }}
        run: |
          # å†…éƒ¨å˜é‡åˆ†æ‹£
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            TAG=$MAIN_TAG
          else
            TAG=$DEV_TAG
          fi

          # æ‰§è¡Œç¼–è¯‘ (è¿›å…¥ src ç›®å½•)
          cd src
          bash ../scripts/build.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG"

          # æ‰§è¡ŒåŒ…è£…
          bash ../scripts/package.sh ${{ matrix.os }} ${{ matrix.arch }} "${{ matrix.v }}" "$TAG" "${{ matrix.branch }}"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # æ³¨æ„ï¼šArtifact Name å¿…é¡»å”¯ä¸€ï¼Œé˜²æ­¢å¹¶å‘å†²çª
          name: bin-${{ matrix.branch }}-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.v }}
          path: output/*

  publish:
    needs: [check, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
    steps:
      - name: Download Assets
        uses: actions/download-artifact@v4
        with:
          # æ ¹æ®å‰ç¼€ä¸‹è½½è¯¥åˆ†æ”¯çš„æ‰€æœ‰äº§ç‰©
          pattern: bin-${{ matrix.branch }}-*
          path: dist
          merge-multiple: true

      # å¢åŠ è¿™ä¸€æ­¥ï¼šè·å–åŒ—äº¬æ—¶é—´
      - name: Get Build Time
        id: time
        run: |
          # è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          echo "now=$(date -d '+8 hours' +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Set Env
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            echo "REL_TAG=${{ needs.check.outputs.main_tag }}" >> $GITHUB_ENV
            echo "UPSTREAM_TIME=${{ needs.check.outputs.latest_time }}" >> $GITHUB_ENV
          else
            echo "REL_TAG=${{ needs.check.outputs.dev_tag }}-dev" >> $GITHUB_ENV
            # Dev åˆ†æ”¯å¯èƒ½æ²¡æœ‰ç‰¹å®šçš„æ—¶é—´ï¼Œä¹Ÿå¯ä»¥ç”¨ check ä»»åŠ¡ä¼ è¿‡æ¥çš„
            echo "UPSTREAM_TIME=${{ needs.check.outputs.latest_time }}" >> $GITHUB_ENV
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.REL_TAG }}
          name: sing-box reF1nd [${{ matrix.branch }}]
          # åœ¨ Body æ³¨å…¥æ„å»ºæ—¶é—´
          body: |
            ### ğŸ› ï¸ æ„å»ºä¿¡æ¯ (Build Info)
            - **åˆ†æ”¯ (Branch)**: `${{ matrix.branch }}`
            - **ä¸Šæ¸¸æ›´æ–°æ—¥æœŸ (Upstream Time)**: `${{ env.UPSTREAM_TIME }}`
            - **æ„å»ºå®Œæˆæ—¶é—´ (Build Time)**: `${{ steps.time.outputs.now }} (UTC+8)`

            ### ğŸ”— æºä»£ç 
            - [reF1nd/sing-box](https://github.com/reF1nd/sing-box/tree/${{ matrix.branch }})
          files: dist/*

  package_arch:
    needs: [check, build]
    runs-on: ubuntu-latest
    # ä½¿ç”¨ ArchLinux å®˜æ–¹æ„å»ºé•œåƒï¼Œè‡ªå¸¦ makepkg å’Œ repo-add
    container: archlinux:base-devel
    strategy:
      matrix:
        branch: [reF1nd-main, reF1nd-dev]
    steps:
      - uses: actions/checkout@v4
      
      # ä¸‹è½½è¯¥åˆ†æ”¯çš„æ‰€æœ‰ Artifacts
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bin-${{ matrix.branch }}-*
          path: artifacts

      - name: Init Environment
        run: |
          pacman -Syu --noconfirm git wget sudo
          # å…è®¸ nobody ç”¨æˆ·ä½¿ç”¨ sudo (makepkg éœ€è¦)
          echo "nobody ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Build Arch Repo
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          if [ "${{ matrix.branch }}" == "reF1nd-main" ]; then
            TAG=${{ needs.check.outputs.main_tag }}
          else
            TAG=${{ needs.check.outputs.dev_tag }}
          fi
          # æ‰§è¡Œåˆšæ‰é‚£ä¸ªè„šæœ¬
          bash scripts/arch/build_repo.sh "${{ matrix.branch }}" "$TAG" "$(pwd)/artifacts" "${REPO_TOKEN}"